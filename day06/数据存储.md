# 数据存储

本章介绍Android 4种存储方式的用法，包括共享参数SharedPreferences、数据库SQLite、存储卡文件、App的全局内存，另外介绍Android重要组件—应用Application的基本概念与常见用法。最后，结合本章所学的知识演示实战项目“购物车”的设计与实现。

## **共享参数****SharedPreferences**

###### SharedPreferences 是Android的一个轻量级存储工具，采用的存储结构是Key-Value的键值对方式。 

###### 共享参数的存储介质是符合XML规范的配置文件。保存路径是：/data/data/应用包名/shared_prefs/文件名.xml

下面是一个共享参数的XML文件例子：

```xml
<?xml version='1.0' encoding='utf-8' standalone='yes' ?> 

<map>

    <string name="name">Mr Lee</string> 

    <int nane="age" value="30"/> 

    <boolean name="married" value="true" /> 

    <float name="weight" value="100.0"/> 

</map>
```

### **共享参数的使用场景** 

共享参数主要适用于如下场合： 

- 简单且孤立的数据。若是复杂且相互间有关的数据，则要保存在数据库中。 

- 文本形式的数据。若是二进制数据，则要保存在文件中。 

- 需要持久化存储的数据。在App退出后再次启动时，之前保存的数据仍然有效。 

###### 实际开发中，共享参数经常存储的数据有App的个性化配置信息、用户使用App的行为信息、临时需要保存的片段信息等

![image-20221008223159743](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008223159743.png)

new > model > study05

new > activity > ShareWriteActivity

copy > edit_selector\shape_edit***

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="5dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">

        <TextView
            android:id="@+id/tv_name"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="姓名："
            android:textColor="@color/black"
            android:textSize="17sp" />

        <EditText
            android:id="@+id/et_name"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入姓名"
            android:inputType="text"
            android:maxLength="12"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_age"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="年龄："
            android:textColor="@color/black"
            android:textSize="17sp" />

        <EditText
            android:id="@+id/et_age"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入年龄"
            android:inputType="number"
            android:maxLength="2"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_height"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="身高："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_height"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入身高"
            android:inputType="number"
            android:maxLength="3"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_weight"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="体重："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_weight"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入体重"
            android:inputType="numberDecimal"
            android:maxLength="5"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <CheckBox
        android:id="@+id/ck_married"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:checked="false"
        android:gravity="center"
        android:text="已婚"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_save"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="保存到共享参数"
        android:textColor="@color/black"
        android:textSize="17sp" />

</LinearLayout>
```

###### 共享参数对数据的存储和读取操作类似于Map，也有存储数据的put方法，以及读取数据的get方法。调用getSharedPreferences方法可以获得共享参数实例，获取代码示例如下:

```xml
// 从share.xml获取共享参数实例 
SharedPreferences shared = getSharedPreferences("share", MODE_PRIVATE);
//getSharedPreferences方法的第一个参数是文件名，填share表示共享参数的文件名是share.xml；第二个参数是操作模式，填MODE_PRIVATE表示私有模式。
```

共享参数存储数据要借助于Editor类，保存数据的代码示例如下：

```java
SharedPreferences.Editor editor = shared.edit(); // 获得编辑器的对象 
editor.putString("name", "Mr Lee"); // 添加一个名为name的字符串参数 
editor.putInt("age", 30); // 添加一个名为age的整型参数 
editor.putBoolean("married", true); // 添加一个名为married的布尔型参数 
editor.putFloat("weight", 100f); // 添加一个名为weight的浮点数参数 
editor.commit(); // 提交编辑器中的修改
```

```java
public class ShareWriteActivity extends AppCompatActivity implements View.OnClickListener {
    private EditText et_name;
    private EditText et_age;
    private EditText et_height;
    private EditText et_weight;
    private CheckBox ck_married;
    private SharedPreferences preferences;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_share_write);
        et_name = findViewById(R.id.et_name);
        et_age = findViewById(R.id.et_age);
        et_height = findViewById(R.id.et_height);
        et_weight = findViewById(R.id.et_weight);
        ck_married = findViewById(R.id.ck_married);

        findViewById(R.id.btn_save).setOnClickListener(this);
        // 从config.xml获取共享参数实例
        //getSharedPreferences方法的第一个参数是文件名，填config表示共享参数的文件名是config.xml；
        // 第二个参数是操作模式，填MODE_PRIVATE表示私有模式。
        preferences = getSharedPreferences("config", Context.MODE_PRIVATE);
		//调用读取
        reload();
    }

    @Override
    public void onClick(View v) {
//        获取输入框输入的内容
        String name = et_name.getText().toString();
        String age = et_age.getText().toString();
        String height = et_height.getText().toString();
        String weight = et_weight.getText().toString();
//        共享参数存储数据要借助于Editor类
        SharedPreferences.Editor editor = preferences.edit();
        editor.putString("name", name);
        editor.putInt("age", Integer.parseInt(age));
        editor.putFloat("height", Float.parseFloat(height));
        editor.putFloat("weight", Float.parseFloat(weight));
        editor.putBoolean("married", ck_married.isChecked());
        editor.commit();
    }
//    读取出保存的数据
    private void reload() {
        String name = preferences.getString("name", null);
        if (name != null) {
            et_name.setText(name);
        }

        int age = preferences.getInt("age", 0);
        if (age != 0) {
            et_age.setText(String.valueOf(age));
        }

        float height = preferences.getFloat("height", 0f);
        if (height != 0f) {
            et_height.setText(String.valueOf(height));
        }

        float weight = preferences.getFloat("weight", 0f);
        if (weight != 0f) {
            et_weight.setText(String.valueOf(weight));
        }

        boolean married = preferences.getBoolean("married", false);
        ck_married.setChecked(married);
    }
}
```

### **实现记住密码功能**

###### 上一章的实战项目在登录页面下方有一个“记住密码”复选框，现在利用共享参数对该项目进行改造，使之实现记住密码的功能。改造的内容主要有3处： 

- 声明一个共享参数对象，并在onCreate函数中调用getSharedPreferences方法获取共享参数的实例。 

- 登录成功时，如果用户勾选了“记住密码”，就使用共享参数保存手机号码与密码。 

- 再次打开登录页面时，App从共享参数中读取手机号码与密码，并展示在界面上。 

### “记住密码”的演示效果** 

![image-20221008221254249](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008221254249.png)

LoginActivity

```java
private SharedPreferences preferences;
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login);
        .....
        preferences = getSharedPreferences("config", Context.MODE_PRIVATE);
        reload();
    }
 private void reload() {
//        是否勾选过记住密码
        boolean isRemember = preferences.getBoolean("isRemember", false);
        if (isRemember) {
            String phone = preferences.getString("phone", "");
            et_phone.setText(phone);

            String password = preferences.getString("password", "");
            et_password.setText(password);
            ck_remember.setChecked(true);
        }
    }
// 校验通过，登录成功
    private void loginSuccess() {
        String desc = String.format("您的手机号码是%s，恭喜你通过登录验证，点击“确定”按钮返回上个页面",
                et_phone.getText().toString());
        // 以下弹出提醒对话框，提示用户登录成功
        AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setTitle("登录成功");
        builder.setMessage(desc);
        builder.setPositiveButton("确定返回", (dialog, which) -> {
            // 结束当前的活动页面
            finish();
        });
        builder.setNegativeButton("我再看看", null);
        AlertDialog dialog = builder.create();
        dialog.show();
//    判断记住密码是否勾选
        if (ck_remember.isChecked()) {
            SharedPreferences.Editor editor = preferences.edit();
            editor.putString("phone", et_phone.getText().toString());
            editor.putString("password", et_password.getText().toString());
            editor.putBoolean("isRemember", ck_remember.isChecked());
            editor.commit();
        }
    }
```

### 练习

![image-20221008235259083](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008235259083.png)

## **数据库****SQLite**

本节介绍Android的数据库存储方式—SQLite的使用方法，包括：SQLite用到了哪些SQL语法，如何使用数据库管理器操纵SQLite，如何使用数据库帮助器简化数据库操作等，以及如何利用SQLite改进登录页面的记住密码功能。

## **SQL****的基本语法**

###### 标准的SQL语句分为三类：数据定义、数据操纵和数据控制，但不同的数据库往往有自己的实现。 

###### SQLite是一种小巧的嵌入式数据库，由于它属于轻型数据库，不涉及复杂的数据控制操 作，因此App开发只用到数据定义和数据操纵两类SQL。 

###### SQLite的SQL语法与通用的SQL语法略有不同

- SQL本质上是一种编程语言，它的学名叫作“结构化查询语言”（全称为Structured Query Language，简称SQL）。不过SQL语言并非通用的编程语言，它专用于数据库的访问和处理，更像是一种操作命令，所以常说SQL语句而不说SQL代码。标准的SQL语句分为3类：数据定义、数据操纵和数据控制，但不同的数据库往往有自己的实现。

- SQLite是一种小巧的嵌入式数据库，使用方便、开发简单。如同MySQL、Oracle那样，SQLite也采用SQL语句管理数据，由于它属于轻型数据库，不涉及复杂的数据控制操作，因此App开发只用到数据定义和数据操纵两类SQL。此外，SQLite的SQL语法与通用的SQL语法略有不同，接下来介绍的两类SQL语法全部基于SQLite。 

### **SQLite****的数据定义语言** 

###### 数据定义语言（DDL）描述了怎样变更数据实体的框架结构。 

###### DDL语言主要包括三种操作：创建表格、删除表格、修改表结构。 

- 创建表格，格式为“CREATE TABLE IF NOT EXISTS 表格名称 (以逗号分隔的各字段定义);” 

  以用户信息表为例，它的建表语句如下所示：

  ```sql
  CREATE TABLE IF NOT EXISTS user_info ( 
  _id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, 
  name VARCHAR NOT NULL, 
  age INTEGER NOT NULL, 
  height LONG NOT NULL, 
  weight FLOAT NOT NULL, 
  married INTEGER NOT NULL, 
  update_time VARCHAR NOT NULL);
  ```

  上面的SQL语法与其他数据库的SQL语法有所出入，相关的注意点说明见下：

  ①SQL语句不区分大小写，无论是create与table这类关键词，还是表格名称、字段名称，都不区分大小写。唯一区分大小写的是被单引号括起来的字符串值。

  ②为避免重复建表，应加上IF NOT EXISTS关键词，例如CREATE TABLE IF NOT EXISTS　表格名称……

  ③SQLite支持整型INTEGER、长整型LONG、字符串VARCHAR、浮点数FLOAT，但不支持布尔类型。布尔类型的数据要使用整型保存，如果直接保存布尔数据，在入库时SQLite会自动将它转为0或1，其中0表示false，1表示true。

  ④建表时需要唯一标识字段，它的字段名为*id*。创建新表都要加上该字段定义，例如id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL。 

- 删除表格，格式为“DROP TABLE IF EXISTS 表格名称;” 

  ```sql
  DROP TABLE IF EXISTS user_info;
  ```

- 修改表结构，格式为“ALTER TABLE 表格名称 修改操作;” 不过SQLite**只支持****增加字段**，不支持修改字段，也不支持删除段。对于字段增加操作，需要在alter之后补充add命令，具体格式如“ALTER TABLE　表格名称　ADD COLUMN　字段名称　字段类型;”。

  ```sql
  ALTER TABLE user_info ADD COLUMN phone VARCHAR;
  ```

### **SQLite****的数据操纵语言**

###### 数据操纵语言（DML）它描述了怎样处理数据实体的内部记录。 

###### 表格记录的操作类型包括添加、删除、修改、查询四类： 

- 添加记录，格式为“INSERT INTO 表格名称 (以逗号分隔的字段名列表) VALUES (以逗号分隔的字段值列表);” 

  ```sql
  INSERT INTO user_info (name,age,height,weight,married,update_time) VALUES ('张三',20,170,50,0,'20200504');
  ```

- 删除记录，格式为“DELETE FROM 表格名称 WHERE 查询条件;” 

  ```sql
  DELETE FROM user_info WHERE name='张三';
  ```

- 修改记录，格式为“UPDATE 表格名称 SET 字段名=字段值 WHERE 查询条件;” 

  ```sql
  UPDATE user_info SET married=1 WHERE name='张三';
  ```

- 查询记录，格式为“SELECT 以逗号分隔的字段名列表 FROM 表格名称 WHERE 查询条件;”

  ```sql
  SELECT * FROM user_info WHERE name='张三';
  SELECT * FROM user_info ORDER BY age ASC;
  ```

  

## **数据库管理器****SQLiteDatabase**

###### SQLiteDatabase是SQLite的数据库管理类，它提供了若干操作数据表的API，常用的方法有3类： 

###### 1.管理类，用于数据库层面的操作

- openDatabase：打开指定路径的数据库。 

- isOpen：判断数据库是否已打开。 

- close：关闭数据库。 

- getVersion：获取数据库的版本号。 

- setVersion：设置数据库的版本号。

![image-20221010210102248](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221010210102248.png)

new > activity > DatabaseActivity

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical">
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">
        <Button
            android:id="@+id/btn_database_create"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="创建数据库"
            android:textColor="@color/black"
            android:textSize="17sp" />
        <Button
            android:id="@+id/btn_database_delete"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="删除数据库"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <TextView
        android:id="@+id/tv_database"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingLeft="5dp"
        android:textColor="@color/black"
        android:textSize="17sp" />
</LinearLayout>
```

```java
public class DatabaseActivity extends AppCompatActivity implements View.OnClickListener {
    private TextView tv_database;
    private String mDatabaseName;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_database);

        tv_database = findViewById(R.id.tv_database);
        findViewById(R.id.btn_database_create).setOnClickListener(this);
        findViewById(R.id.btn_database_delete).setOnClickListener(this);

        // 生成一个测试数据库的完整路径
        mDatabaseName = getFilesDir() + "/test.db";
    }
    @Override
    public void onClick(View v) {
        String desc = null;
        switch (v.getId()) {
            case R.id.btn_database_create:
                // 创建或打开数据库。数据库如果不存在就创建它，如果存在就打开它
                SQLiteDatabase db = openOrCreateDatabase(mDatabaseName, Context.MODE_PRIVATE, null);
                desc = String.format("数据库%s创建%s", db.getPath(), (db != null) ? "成功" : "失败");
                tv_database.setText(desc);
                break;

            case R.id.btn_database_delete:
                // 删除数据库
                boolean result = deleteDatabase(mDatabaseName);
                desc = String.format("数据库%s删除%s", mDatabaseName, result?"成功":"失败");
                tv_database.setText(desc);
                break;
        }
    }
}
```

###### 2. 事务类，用于事务层面的操作。 

- beginTransaction：开始事务。 

- setTransactionSuccessful：设置事务的成功标志。 

- endTransaction：结束事务。 

###### 3.数据处理类，用于数据表层面的操作。 

- execSQL：执行拼接好的SQL控制语句。 

- delete：删除符合条件的记录。 

- update：更新符合条件的记录。 

- insert：插入一条记录。 

- query：执行查询操作，返回结果集的游标。 

- rawQuery：执行拼接好的SQL查询语句，返回结果集的游标。 

### **数据库帮助器****SQLiteOpenHelper** 

###### SQLiteOpenHelper是Android提供的数据库辅助工具，用于指导开发者进行SQLite的合理使用。 

###### SQLiteOpenHelper的具体使用步骤如下： 

- 新建一个继承自SQLiteOpenHelper的数据库操作类，提示重写onCreate和onUpgrade两个方法。 

- 封装保证数据库安全的必要方法。 

- 提供对表记录进行增加、删除、修改、查询的操作方法。

new > acticity > SQLiteHelperActivity

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="5dp">
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_name"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="姓名："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_name"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入姓名"
            android:inputType="text"
            android:maxLength="12"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">

        <TextView
            android:id="@+id/tv_age"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="年龄："
            android:textColor="@color/black"
            android:textSize="17sp" />

        <EditText
            android:id="@+id/et_age"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入年龄"
            android:inputType="number"
            android:maxLength="2"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_height"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="身高："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_height"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入身高"
            android:inputType="number"
            android:maxLength="3"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_weight"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="体重："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_weight"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入体重"
            android:inputType="numberDecimal"
            android:maxLength="5"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <CheckBox
        android:id="@+id/ck_married"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:checked="false"
        android:gravity="center"
        android:text="已婚"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_save"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="添加"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_delete"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="删除"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_update"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="修改"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_query"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="查询"
        android:textColor="@color/black"
        android:textSize="17sp" />

</LinearLayout>
```

通过继承实现SQLiteOpenHelper

new > package 》 database > UserDBHelper类

```java
public class UserDBHelper extends SQLiteOpenHelper {

    private static final String DB_NAME = "user.db"; //数据库名称
    private static final int DB_VERSION = 1;  //版本号
    private static final String TABLE_NAME = "user_info"; // 表名
    private static UserDBHelper mHelper = null; //保存数据库帮助器的唯一实例
    private SQLiteDatabase mRDB = null; //读取数据库实例
    private SQLiteDatabase mWDB = null; //写入数据库实例

//    子类调用父类的构造方法
    private UserDBHelper(Context context) {
//        null 游标工厂
        super(context, DB_NAME, null, DB_VERSION);
    }

    // 获取数据库帮助器的唯一实例
    public static UserDBHelper getInstance(Context context) {
        if (mHelper == null) {
            mHelper = new UserDBHelper(context);
        }
        return mHelper;
    }
    // 打开数据库的读连接
    public SQLiteDatabase openReadLink() {
        if (mRDB == null || !mRDB.isOpen()) {
            mRDB = mHelper.getReadableDatabase();
        }
        return mRDB;
    }
    // 打开数据库的写连接
    public SQLiteDatabase openWriteLink() {
        if (mWDB == null || !mWDB.isOpen()) {
            mWDB = mHelper.getWritableDatabase();
        }
        return mWDB;
    }
    // 关闭数据库连接
    public void closeLink() {
        if (mRDB != null && mRDB.isOpen()) {
            mRDB.close();
            mRDB = null;
        }
        if (mWDB != null && mWDB.isOpen()) {
            mWDB.close();
            mWDB = null;
        }
    }

    // 创建数据库，执行建表语句
    @Override
    public void onCreate(SQLiteDatabase db) {
        String sql = "CREATE TABLE IF NOT EXISTS " + TABLE_NAME + " (" +
                "_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL," +
                "name VARCHAR NOT NULL," +
                "age INTEGER NOT NULL," +
                "height LONG NOT NULL," +
                "weight FLOAT NOT NULL," +
                "married INTEGER NOT NULL);";
        db.execSQL(sql);
    }
    // 数据库版本更新
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    }
//    插入用户数据
    //new > entity > User
    //public class User {
    //public int id; // 序号
    //public String name; // 姓名
    //public int age; // 年龄
    //public long height; // 身高
    //public float weight; // 体重
    //public boolean married; // 婚否
    // 无参构造 全参构造 toString
    
    public long insert(User user) {
//        取出实体类的属性值
        ContentValues values = new ContentValues();
        values.put("name", user.name);
        values.put("age", user.age);
        values.put("height", user.height);
        values.put("weight", user.weight);
        values.put("married", user.married);
        // 执行插入记录动作，该语句返回插入记录的行号
        // 如果第三个参数values 为Null或者元素个数为0， 由于insert()方法要求必须添加一条除了主键之外其它字段为Null值的记录，
        // 为了满足SQL语法的需要， insert语句必须给定一个字段名 ，如：insert into person(name) values(NULL)，
        // 倘若不给定字段名 ， insert语句就成了这样： insert into person() values()，显然这不满足标准SQL的语法。
        // 如果第三个参数values 不为Null并且元素的个数大于0 ，可以把第二个参数设置为null 。
        return mWDB.insert(TABLE_NAME, null, values);
    }
}

```

SQLiteHelperActivity.java

```java
public class SQLiteHelperActivity extends AppCompatActivity implements View.OnClickListener {
    private EditText et_name;
    private EditText et_age;
    private EditText et_height;
    private EditText et_weight;
    private CheckBox ck_married;
    private UserDBHelper mHelper;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_sqlite_helper);

        et_name = findViewById(R.id.et_name);
        et_age = findViewById(R.id.et_age);
        et_height = findViewById(R.id.et_height);
        et_weight = findViewById(R.id.et_weight);
        ck_married = findViewById(R.id.ck_married);

        findViewById(R.id.btn_save).setOnClickListener(this);
        findViewById(R.id.btn_delete).setOnClickListener(this);
        findViewById(R.id.btn_update).setOnClickListener(this);
        findViewById(R.id.btn_query).setOnClickListener(this);
    }

    @Override
    public void onClick(View v) {
        String name = et_name.getText().toString();
        String age = et_age.getText().toString();
        String height = et_height.getText().toString();
        String weight = et_weight.getText().toString();
        User user = null;
        switch (v.getId()) {
            case R.id.btn_save:
                // 以下声明一个用户信息对象，并填写它的各字段值
                user = new User(0,
                        name,
                        Integer.parseInt(age),
                        Long.parseLong(height),
                        Float.parseFloat(weight),
                        ck_married.isChecked());
                if (mHelper.insert(user) > 0) {
                    //new > utils > ToastUtil类
                    //public class ToastUtil {
                    //    public static void show(Context ctx, String desc) {
                    //        Toast.makeText(ctx, desc, Toast.LENGTH_SHORT).show();
                    //    }
                    //}
                    ToastUtil.show(this, "添加成功");
                }
                break;
            case R.id.btn_delete:
                break;
            case R.id.btn_update:
                break;
            case R.id.btn_query:
                break;
        }
    }
//  页面显示
    @Override
    protected void onStart() {
        super.onStart();
        // 获得数据库帮助器的实例
        mHelper = UserDBHelper.getInstance(this);
        // 打开数据库帮助器的读写连接
        mHelper.openWriteLink();
        mHelper.openReadLink();
    }
//    页面隐藏
    @Override
    protected void onStop() {
        super.onStop();
        // 关闭数据库连接
        mHelper.closeLink();
    }
}
```

###### 删除用户

UserDBHelper类

```java
//    删除数据
    public long deleteByName(String name) {
        return mWDB.delete(TABLE_NAME, "name=?", new String[]{name});
    }
//    更新数据
    public long update(User user) {
        ContentValues values = new ContentValues();
        values.put("name", user.name);
        values.put("age", user.age);
        values.put("height", user.height);
        values.put("weight", user.weight);
        values.put("married", user.married);
        return mWDB.update(TABLE_NAME, values, "name=?", new String[]{user.name});
    }
//    查询所有的数据
    public List<User> queryAll() {
        List<User> list = new ArrayList<>();
        // 执行记录查询动作，该语句返回结果集的游标
        // 游标是一行一行读取数据
        Cursor cursor = mRDB.query(TABLE_NAME, null, null, null, null, null, null);
        // 循环取出游标指向的每条记录
        while (cursor.moveToNext()) { //有下一行就读下一行
            User user = new User();
            user.id = cursor.getInt(0);
            user.name = cursor.getString(1);
            user.age = cursor.getInt(2);
            user.height = cursor.getLong(3);
            user.weight = cursor.getFloat(4);
            //SQLite没有布尔型，用0表示false，用1表示true
            user.married = (cursor.getInt(5) == 0) ? false : true;
            list.add(user);
        }
        return list;
    }
//根据名称查询
public List<User> queryByName(String name) {
        List<User> list = new ArrayList<>();
        // 执行记录查询动作，该语句返回结果集的游标
        Cursor cursor = mRDB.query(TABLE_NAME, null, "name=?", new String[]{name}, null, null, null);
        // 循环取出游标指向的每条记录
        while (cursor.moveToNext()) {
            User user = new User();
            user.id = cursor.getInt(0);
            user.name = cursor.getString(1);
            user.age = cursor.getInt(2);
            user.height = cursor.getLong(3);
            user.weight = cursor.getFloat(4);
            //SQLite没有布尔型，用0表示false，用1表示true
            user.married = (cursor.getInt(5) == 0) ? false : true;
            list.add(user);
        }
        return list;
}
```

SQLiteHelperActivity.java

```java
case R.id.btn_delete:
if (mHelper.deleteByName(name) > 0) {
    ToastUtil.show(this, "删除成功");
}
break;
case R.id.btn_update:
user = new User(0,name,
                Integer.parseInt(age),
                Long.parseLong(height),
                Float.parseFloat(weight),
                ck_married.isChecked());
if (mHelper.update(user) > 0) {
    ToastUtil.show(this, "修改成功");
}
break;
case R.id.btn_query:
List<User> list = mHelper.queryAll();
//List<User> list = mHelper.queryByName(name);
for (User u : list) {
    Log.d("test", u.toString());
}
break;
```

##### 事务类

```java
UserDBHelper.java
    
//    插入用户数据
    public long insert(User user) {
//        取出实体类的属性值
        ContentValues values = new ContentValues();
        values.put("name", user.name);
        values.put("age", user.age);
        values.put("height", user.height);
        values.put("weight", user.weight);
        values.put("married", user.married);
       
        //return mWDB.insert(TABLE_NAME, null, values);

        try {
            mWDB.beginTransaction(); //放到事务里，开始事务。
            mWDB.insert(TABLE_NAME, null, values);
            mWDB.setTransactionSuccessful(); //设置事务的成功标志。
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            mWDB.endTransaction(); //结束事务。
        }
        return 1;
    }
```

##### 版本升级

```java
 UserDBHelper.java
private static final int DB_VERSION = 2;  //版本号
// 数据库版本更新会执行
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
//        添加两个字段
        String sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN phone VARCHAR;";
        db.execSQL(sql);
        sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN password VARCHAR;";
        db.execSQL(sql);
    }
```

## **优化记住密码功能**

###### 利用共享参数实现记住密码，只能记住一个用户的登录信息，并且手机号码跟密码不存在从属关系，如果换个手机号码登录，前一个用户的登录信息就被覆盖了。

###### 真正的记住密码功能是先输入手机号码，然后根据手机号匹配保存的密码，一个密码对应一个手机号码，从而实现具体手机号码的密码记忆功能。

###### 运用SQLite技术分条存储不同用户的登录信息，并提供根据手机号码查找登录信息的方法，这样可以同时记住多个手机号码的密码。

### **利用****SQLite****记住密码的步骤**

利用SQLite记住密码有以下三处改造：

- 声明一个用户数据库的帮助器对象，然后在活动页面的onResume方法中打开数据库连接，在onPasue方法中关闭数据库连接。

- 登录成功时，如果用户勾选了“记住密码” ，就使用数据库保存手机号码与密码在内的登录信息。

- 再次打开登录页面，用户输入手机号完毕后点击密码输入框时，App到数据库中根据手机号查找登录记录，并将记录结果中的密码填入密码框。

new > activity > LoginSQLiteActivity =>copy LoginActivity

copy => database > UserDBHelper => LoginDBHelper

```xml
public class LoginDBHelper extends SQLiteOpenHelper {

    private static final String DB_NAME = "login.db"; //数据库名称
    private static final int DB_VERSION = 1;  //版本号
    private static final String TABLE_NAME = "login_info"; // 表名
// 数据库版本更新会执行
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
//        添加两个字段
//        String sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN phone VARCHAR;";
//        db.execSQL(sql);
//        sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN password VARCHAR;";
//        db.execSQL(sql);
    }
```

new > entity > Login类

```xml
public class Login {
    public int id;
    public String phone;
    public String password;
    public boolean remember = false;
// 无参、有参、toString()
```

LoginDBHelper类

```java
// 创建数据库，执行建表语句
    @Override
    public void onCreate(SQLiteDatabase db) {
        String sql = "CREATE TABLE IF NOT EXISTS " + TABLE_NAME + " (" +
                "_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL," +
                " phone VARCHAR NOT NULL," +
                " password VARCHAR NOT NULL," +
                " remember INTEGER NOT NULL);";
        db.execSQL(sql);
    }
    // 数据库版本更新会执行
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
//        添加两个字段
//        String sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN phone VARCHAR;";
//        db.execSQL(sql);
//        sql = "ALTER TABLE " + TABLE_NAME + " ADD COLUMN password VARCHAR;";
//        db.execSQL(sql);
    }
//    插入用户数据
    public long insert(Login login) {
//        取出实体类的属性值
        ContentValues values = new ContentValues();
        values.put("phone", login.phone);
        values.put("password", login.password);
        values.put("remember", login.remember);
        return mWDB.insert(TABLE_NAME, null, values);
    }
    //    添加逻辑处理
    public void save(Login login) {
        // 如果存在则先删除，再添加
        try {
            mWDB.beginTransaction();
            delete(login);
            insert(login);
            mWDB.setTransactionSuccessful();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            mWDB.endTransaction();
        }
    }
    //    根据手机号删除
    public long delete(Login login) {
        return mWDB.delete(TABLE_NAME, "phone=?", new String[]{login.phone});
    }
```

LoginSQLiteActivity.java

```java
public class LoginSQLiteActivity extends AppCompatActivity implements RadioGroup.OnCheckedChangeListener, View.OnClickListener {
	private LoginDBHelper loginDBHelper;
     @Override
    protected void onCreate(Bundle savedInstanceState) {
        //        preferences = getSharedPreferences("config", Context.MODE_PRIVATE);
		//        reload();
    }
     @Override
    protected void onStart() {
        super.onStart();
        loginDBHelper = LoginDBHelper.getInstance(this);
        loginDBHelper.openReadLink();
        loginDBHelper.openWriteLink();
//        获取数据链接之后才能读取数据
        reload();
    }

    @Override
    protected void onStop() {
        super.onStop();
        loginDBHelper.closeLink();
    }
    
    // 校验通过，登录成功
    private void loginSuccess() {
        //    判断记住密码是否勾选
//        if (ck_remember.isChecked()) {
//            SharedPreferences.Editor editor = preferences.edit();
//            editor.putString("phone", et_phone.getText().toString());
//            editor.putString("password", et_password.getText().toString());
//            editor.putBoolean("isRemember", ck_remember.isChecked());
//            editor.commit();
//        }
//        保存到数据库
        Login login = new Login();
        login.phone = et_phone.getText().toString();
        login.password = et_password.getText().toString();
        login.remember = ck_remember.isChecked();
        loginDBHelper.save(login);
    }
}
```

LoginDBHelper.java

```java
//    查询最后一个登录的用户信息
    public Login queryTop() {
        Login login = null;
        String sql = "select * from " + TABLE_NAME + " where remember = 1 ORDER BY _id DESC limit 1";
        // 执行记录查询动作，该语句返回结果集的游标
        Cursor cursor = mRDB.rawQuery(sql, null);
        if (cursor.moveToNext()) {
            login = new Login();
            login.id = cursor.getInt(0);
            login.phone = cursor.getString(1);
            login.password = cursor.getString(2);
            login.remember = (cursor.getInt(3) == 0) ? false : true;
        }
        return login;
    }
```

LoginSQLiteActivity.java

```java
private void reload() {
        Login login = loginDBHelper.queryTop();
        if (login != null && login.remember) {
            et_phone.setText(login.phone);
            et_password.setText(login.password);
            ck_remember.setChecked(true);
        }
}
```

#### **优化****“****记住密码****”****的演示效果**

![image-20221014100906352](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221014100906352.png)

```
当密码输入框获取焦点之后，根据输入的电话号码，查询出对应的密码，自动填入
```

LoginDBHelper.java

```java
//根据手机号查询当前输入的用户信息
    public Login queryByPhone(String phone) {
        Login login = null;
        String sql = "select * from " + TABLE_NAME;
        // 执行记录查询动作，该语句返回结果集的游标
        Cursor cursor = mRDB.query(TABLE_NAME, null, "phone=?", new String[]{phone}, null, null, null);
        if (cursor.moveToNext()) {
            login = new Login();
            login.id = cursor.getInt(0);
            login.phone = cursor.getString(1);
            login.password = cursor.getString(2);
            login.remember = (cursor.getInt(3) == 0) ? false : true;
        }
        return login;
    }
```

LoginSQLiteActivity.java

```java
 et_password.setOnFocusChangeListener(this);
// 当密码输入框获取焦点之后，根据输入的电话号码，查询出对应的密码，自动填入
    @Override
    public void onFocusChange(View v, boolean hasFocus) {
        if (v.getId() == R.id.et_password && hasFocus) {
            Login login = loginDBHelper.queryByPhone(et_phone.getText().toString());
            // 如果根据电话号码，查询出了密码
            if (login != null) {
                et_password.setText(login.password);
                ck_remember.setChecked(login.remember);
            } else {
                // 没有查到，清空密码
                et_password.setText("");
                ck_remember.setChecked(false);
            }
        }
    }
```



