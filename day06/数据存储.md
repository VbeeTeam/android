# 数据存储

本章介绍Android 4种存储方式的用法，包括共享参数SharedPreferences、数据库SQLite、存储卡文件、App的全局内存，另外介绍Android重要组件—应用Application的基本概念与常见用法。最后，结合本章所学的知识演示实战项目“购物车”的设计与实现。

## **共享参数****SharedPreferences**

###### SharedPreferences 是Android的一个轻量级存储工具，采用的存储结构是Key-Value的键值对方式。 

###### 共享参数的存储介质是符合XML规范的配置文件。保存路径是：/data/data/应用包名/shared_prefs/文件名.xml

下面是一个共享参数的XML文件例子：

```xml
<?xml version='1.0' encoding='utf-8' standalone='yes' ?> 

<map>

    <string name="name">Mr Lee</string> 

    <int nane="age" value="30"/> 

    <boolean name="married" value="true" /> 

    <float name="weight" value="100.0"/> 

</map>
```

### **共享参数的使用场景** 

共享参数主要适用于如下场合： 

- 简单且孤立的数据。若是复杂且相互间有关的数据，则要保存在数据库中。 

- 文本形式的数据。若是二进制数据，则要保存在文件中。 

- 需要持久化存储的数据。在App退出后再次启动时，之前保存的数据仍然有效。 

###### 实际开发中，共享参数经常存储的数据有App的个性化配置信息、用户使用App的行为信息、临时需要保存的片段信息等

![image-20221008223159743](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008223159743.png)

new > model > study05

new > activity > ShareWriteActivity

copy > edit_selector\shape_edit***

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="5dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">

        <TextView
            android:id="@+id/tv_name"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="姓名："
            android:textColor="@color/black"
            android:textSize="17sp" />

        <EditText
            android:id="@+id/et_name"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入姓名"
            android:inputType="text"
            android:maxLength="12"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_age"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="年龄："
            android:textColor="@color/black"
            android:textSize="17sp" />

        <EditText
            android:id="@+id/et_age"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入年龄"
            android:inputType="number"
            android:maxLength="2"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_height"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="身高："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_height"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入身高"
            android:inputType="number"
            android:maxLength="3"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="40dp"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/tv_weight"
            android:layout_width="wrap_content"
            android:layout_height="match_parent"
            android:gravity="center"
            android:text="体重："
            android:textColor="@color/black"
            android:textSize="17sp" />
        <EditText
            android:id="@+id/et_weight"
            android:layout_width="0dp"
            android:layout_height="match_parent"
            android:layout_marginTop="3dp"
            android:layout_marginBottom="3dp"
            android:layout_weight="1"
            android:background="@drawable/edit_selector"
            android:hint="请输入体重"
            android:inputType="numberDecimal"
            android:maxLength="5"
            android:textColor="@color/black"
            android:textSize="17sp" />
    </LinearLayout>
    <CheckBox
        android:id="@+id/ck_married"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:checked="false"
        android:gravity="center"
        android:text="已婚"
        android:textColor="@color/black"
        android:textSize="17sp" />
    <Button
        android:id="@+id/btn_save"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="保存到共享参数"
        android:textColor="@color/black"
        android:textSize="17sp" />

</LinearLayout>
```

###### 共享参数对数据的存储和读取操作类似于Map，也有存储数据的put方法，以及读取数据的get方法。调用getSharedPreferences方法可以获得共享参数实例，获取代码示例如下:

```xml
// 从share.xml获取共享参数实例 
SharedPreferences shared = getSharedPreferences("share", MODE_PRIVATE);
//getSharedPreferences方法的第一个参数是文件名，填share表示共享参数的文件名是share.xml；第二个参数是操作模式，填MODE_PRIVATE表示私有模式。
```

共享参数存储数据要借助于Editor类，保存数据的代码示例如下：

```java
SharedPreferences.Editor editor = shared.edit(); // 获得编辑器的对象 
editor.putString("name", "Mr Lee"); // 添加一个名为name的字符串参数 
editor.putInt("age", 30); // 添加一个名为age的整型参数 
editor.putBoolean("married", true); // 添加一个名为married的布尔型参数 
editor.putFloat("weight", 100f); // 添加一个名为weight的浮点数参数 
editor.commit(); // 提交编辑器中的修改
```

```java
public class ShareWriteActivity extends AppCompatActivity implements View.OnClickListener {
    private EditText et_name;
    private EditText et_age;
    private EditText et_height;
    private EditText et_weight;
    private CheckBox ck_married;
    private SharedPreferences preferences;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_share_write);
        et_name = findViewById(R.id.et_name);
        et_age = findViewById(R.id.et_age);
        et_height = findViewById(R.id.et_height);
        et_weight = findViewById(R.id.et_weight);
        ck_married = findViewById(R.id.ck_married);

        findViewById(R.id.btn_save).setOnClickListener(this);
        // 从config.xml获取共享参数实例
        //getSharedPreferences方法的第一个参数是文件名，填config表示共享参数的文件名是config.xml；
        // 第二个参数是操作模式，填MODE_PRIVATE表示私有模式。
        preferences = getSharedPreferences("config", Context.MODE_PRIVATE);
		//调用读取
        reload();
    }

    @Override
    public void onClick(View v) {
//        获取输入框输入的内容
        String name = et_name.getText().toString();
        String age = et_age.getText().toString();
        String height = et_height.getText().toString();
        String weight = et_weight.getText().toString();
//        共享参数存储数据要借助于Editor类
        SharedPreferences.Editor editor = preferences.edit();
        editor.putString("name", name);
        editor.putInt("age", Integer.parseInt(age));
        editor.putFloat("height", Float.parseFloat(height));
        editor.putFloat("weight", Float.parseFloat(weight));
        editor.putBoolean("married", ck_married.isChecked());
        editor.commit();
    }
//    读取出保存的数据
    private void reload() {
        String name = preferences.getString("name", null);
        if (name != null) {
            et_name.setText(name);
        }

        int age = preferences.getInt("age", 0);
        if (age != 0) {
            et_age.setText(String.valueOf(age));
        }

        float height = preferences.getFloat("height", 0f);
        if (height != 0f) {
            et_height.setText(String.valueOf(height));
        }

        float weight = preferences.getFloat("weight", 0f);
        if (weight != 0f) {
            et_weight.setText(String.valueOf(weight));
        }

        boolean married = preferences.getBoolean("married", false);
        ck_married.setChecked(married);
    }
}
```

### **实现记住密码功能**

###### 上一章的实战项目在登录页面下方有一个“记住密码”复选框，现在利用共享参数对该项目进行改造，使之实现记住密码的功能。改造的内容主要有3处： 

- 声明一个共享参数对象，并在onCreate函数中调用getSharedPreferences方法获取共享参数的实例。 

- 登录成功时，如果用户勾选了“记住密码”，就使用共享参数保存手机号码与密码。 

- 再次打开登录页面时，App从共享参数中读取手机号码与密码，并展示在界面上。 

### “记住密码”的演示效果** 

![image-20221008221254249](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008221254249.png)

LoginActivity

```java
private SharedPreferences preferences;
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login);
        .....
        preferences = getSharedPreferences("config", Context.MODE_PRIVATE);
        reload();
    }
 private void reload() {
//        是否勾选过记住密码
        boolean isRemember = preferences.getBoolean("isRemember", false);
        if (isRemember) {
            String phone = preferences.getString("phone", "");
            et_phone.setText(phone);

            String password = preferences.getString("password", "");
            et_password.setText(password);
            ck_remember.setChecked(true);
        }
    }
// 校验通过，登录成功
    private void loginSuccess() {
        String desc = String.format("您的手机号码是%s，恭喜你通过登录验证，点击“确定”按钮返回上个页面",
                et_phone.getText().toString());
        // 以下弹出提醒对话框，提示用户登录成功
        AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setTitle("登录成功");
        builder.setMessage(desc);
        builder.setPositiveButton("确定返回", (dialog, which) -> {
            // 结束当前的活动页面
            finish();
        });
        builder.setNegativeButton("我再看看", null);
        AlertDialog dialog = builder.create();
        dialog.show();
//    判断记住密码是否勾选
        if (ck_remember.isChecked()) {
            SharedPreferences.Editor editor = preferences.edit();
            editor.putString("phone", et_phone.getText().toString());
            editor.putString("password", et_password.getText().toString());
            editor.putBoolean("isRemember", ck_remember.isChecked());
            editor.commit();
        }
    }
```

### 练习

![image-20221008235259083](C:\Users\15596\AppData\Roaming\Typora\typora-user-images\image-20221008235259083.png)

## **SQL****的基本语法**

###### 标准的SQL语句分为三类：数据定义、数据操纵和数据控制，但不同的数据库往往有自己的实现。 

###### SQLite是一种小巧的嵌入式数据库，由于它属于轻型数据库，不涉及复杂的数据控制操 作，因此App开发只用到数据定义和数据操纵两类SQL。 

###### SQLite的SQL语法与通用的SQL语法略有不同

- SQL本质上是一种编程语言，它的学名叫作“结构化查询语言”（全称为Structured Query Language，简称SQL）。不过SQL语言并非通用的编程语言，它专用于数据库的访问和处理，更像是一种操作命令，所以常说SQL语句而不说SQL代码。标准的SQL语句分为3类：数据定义、数据操纵和数据控制，但不同的数据库往往有自己的实现。

- SQLite是一种小巧的嵌入式数据库，使用方便、开发简单。如同MySQL、Oracle那样，SQLite也采用SQL语句管理数据，由于它属于轻型数据库，不涉及复杂的数据控制操作，因此App开发只用到数据定义和数据操纵两类SQL。此外，SQLite的SQL语法与通用的SQL语法略有不同，接下来介绍的两类SQL语法全部基于SQLite。 

### **SQLite****的数据定义语言** 

###### 数据定义语言（DDL）描述了怎样变更数据实体的框架结构。 

###### DDL语言主要包括三种操作：创建表格、删除表格、修改表结构。 

- 创建表格，格式为“CREATE TABLE IF NOT EXISTS 表格名称 (以逗号分隔的各字段定义);” 

- 删除表格，格式为“DROP TABLE IF EXISTS 表格名称;” 

- 修改表结构，格式为“ALTER TABLE 表格名称 修改操作;” 

- SQLite只支持增加字段，不支持修改字段，也不支持删除字段。

